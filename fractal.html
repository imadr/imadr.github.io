<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Fractals</title>
    <link rel="stylesheet" href="css/style.css">
    <link id="css" rel="stylesheet" href="css/dark.css">
    <style>
    body{
        overflow: hidden;
        max-width: inherit;
        width: 100%;
        margin: 0;
        padding: 0;
    }
    #canvas{
        position: absolute;
        top: 0px;
        left: 0px;
        z-index: 0;
    }
    #settings{
        z-index: 1;
        position: absolute;
        display: inline-block;
        top: 10px;
        right: 10px;
        border: 1px solid white;
        padding: 10px;
    }
    #settings, input{
        background-color: rgba(0, 0, 0, 0.5);
    }
    #show_button{
        position: absolute;
        top: 10px;
        left: 10px;
    }
    .p{
        margin-bottom: 8px;
    }
    </style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="settings">
    <div class="p"><button id="hide_button">Hide Settings</button></div>
    <div class="p">Max iterations: <input type="number" id="max_iter_input" min="0"></div>
    <div class="p">Unbound magnitude: <input type="number" id="unbound_magnitude_input" step="0.1" min="0"></div>
    <div class="p">Zoom: <input type="text" id="zoom_input" step="0.1" min="0"></div>
    <div class="p">Center X: <input type="text" id="center_x_input"> Center Y: <input type="text" id="center_y_input" step="0.1"></div>
    <div class="p"><button id="update_button">Update</button> <button id="reset_button">Reset</button> <button id="save_button">Save Image</button></div>
    <div class="p">Time: <span id="time"></span></div>
</div>
<button class="invisible" id="show_button">â–º</button>
<script>
function get(i){
    return document.getElementById(i);
}
get("hide_button").addEventListener("click", function(){
    get("settings").classList.toggle("invisible");
    get("show_button").classList.toggle("invisible");
});

get("show_button").addEventListener("click", function(){
    get("settings").classList.toggle("invisible");
    get("show_button").classList.toggle("invisible");
});

get("update_button").addEventListener("click", function(){
    update();
});

get("reset_button").addEventListener("click", function(){
    reset();
});

get("save_button").addEventListener("click", function(){
    window.open(canvas.toDataURL("image/png"), "_blank");
});

function bind(key, id){
    get(id).value = settings[key];
    get(id).addEventListener("input", function(){
        settings[key] = parseFloat(this.value);
    });
}

function add(a, b){
    return [a[0]+b[0], a[1]+b[1]];
}

function multiply(a, b){
    return [a[0]*b[0]-a[1]*b[1], a[0]*b[1]+a[1]*b[0]];
}

function iter(c, z){
    return add(multiply(z, z), c);
}

function magnitude(c){
    return Math.sqrt(c[0]*c[0]+c[1]*c[1]);
}

var colors = [];
var step = 2;
var color_range = [0, 100];
for(var i = color_range[0]; i < color_range[1]; i+=step){
    colors.push(i);
}
for(var i = color_range[1]; i >= color_range[0]; i-=step){
    colors.push(i);
}

function update(){
    var begin = new Date();

    canvas.width = document.documentElement.clientWidth;
    canvas.height = document.documentElement.clientHeight;

    var imageData = ctx.createImageData(canvas.width, canvas.height);

    for(var j = 0; j < canvas.height; j++){
        for(var i = 0; i < canvas.width; i++){
            var re = (i/canvas.height-canvas.width/2/canvas.height)/settings["zoom"]+settings["center_x"];
            var im = (j/canvas.height-canvas.height/2/canvas.height)/settings["zoom"]-settings["center_y"];

            var c = [re, im];
            var z = [0, 0];
            for(var n = 0; n < settings["max_iter"]; n++){
                z = iter(c, z);
                if(magnitude(z) > settings["unbound_magnitude"]) break;
            }

            var pos = (i+j*canvas.width)*4;
            if(magnitude(z) > settings["unbound_magnitude"]){
                var color = colors[n%colors.length];
                imageData.data[pos] = color;
                imageData.data[pos+1] = color;
                imageData.data[pos+2] = color;
                imageData.data[pos+3] = 255;
            }
            else{
                imageData.data[pos] = 255;
                imageData.data[pos+1] = 255;
                imageData.data[pos+2] = 255;
                imageData.data[pos+3] = 255;
            }
        }
    }

    ctx.putImageData(imageData, 0, 0);
    get("time").innerHTML = (new Date()-begin)/1000+"s";
}

function reset(){
    settings = {"max_iter": 50, "unbound_magnitude": 2, "zoom": 0.4, "center_x": 0, "center_y": 0};
    update();
}

function zoom(x, y, zoom){
    var new_center_x = (x/canvas.height-canvas.width/2/canvas.height)/settings["zoom"]+settings["center_x"];
    var new_center_y = -1*(y/canvas.height-canvas.height/2/canvas.height)/settings["zoom"]+settings["center_y"];
    settings["center_x"] = new_center_x;
    settings["center_y"] = new_center_y;

    if(zoom){
        settings["zoom"] *= 2;
        settings["max_iter"] += 10;
    }
    else{
        settings["zoom"] /= 2;
        settings["max_iter"] -= 10;
    }

    if(settings["max_iter"] <= 10) settings["max_iter"] = 10;

    get("center_x_input").value = settings["center_x"];
    get("center_y_input").value = settings["center_y"];
    get("zoom_input").value = settings["zoom"];
    get("max_iter_input").value = settings["max_iter"];
    update();
}

window.addEventListener("resize", update);
document.body.addEventListener("mousedown", function(e){
    if(e.target == canvas && (e.which == 1 || e.which == 3)) zoom(e.clientX, e.clientY, e.which == 1);
});

var canvas = document.getElementById("canvas");
canvas.oncontextmenu = () => false;
var ctx = canvas.getContext("2d");

var settings = {"max_iter": 50, "unbound_magnitude": 2, "zoom": 0.4, "center_x": 0, "center_y": 0};
bind("max_iter", "max_iter_input");
bind("unbound_magnitude", "unbound_magnitude_input");
bind("zoom", "zoom_input");
bind("center_x", "center_x_input");
bind("center_y", "center_y_input");

update();
</script>
</body>
</html>