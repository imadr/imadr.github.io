<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stuff</title>
    <link rel="stylesheet" href="css/style.css">
    <link id="css" rel="stylesheet" href="css/all.min.css">
    <style>
        body{
            overflow: hidden;
            max-width: inherit;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        main{
            width: 45em;
            max-width: 45em;
            margin-left: auto;
            margin-right: auto;
            padding-top: 3em;
            padding-right: 3em;
            padding-left: 3em;
            height: 100vh;
        }
        h1{
            margin: 0;
            display: inline-block;
        }
        canvas{
            position: absolute;
            top: 0px;
            left: 0px;
            z-index: -1;
            opacity: 0.2;
            image-rendering: optimizeSpeed;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -o-crisp-edges;
            image-rendering: pixelated;
            -ms-interpolation-mode: nearest-neighbor;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<main>
    <div id="menu-icons"></div>
    <h1>imadr.me</h1>
    <h2><a href="bitplane">Bit plane slicing</a></h2>
    <h2><a href="rossmo">Geographic profiling using Rossmo's formula</a></h2>
    <h2><a href="websites.html">Cool websites</a></h2>
    <h2><a href="hello.html">Hello world!</a></h2>
    <script src="js/light.js"></script>
</main>
<canvas id="canvas"></canvas>
<script>
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");
var array_size;
var array;
var anim_request;
var time;
var pixel_size;
var born, survive;

var rules = ["B3/S23", "B3/S12345", "B678/S345678"];
var random = [0.1, 0.1, 0.5];

var random_rule = pick(rules);
var rule = random_rule[1];
var rule_index = random_rule[0];

var pixel_ratio = 4/1366;
var ms = 1;
var min_width = 900;

window.addEventListener("resize", pre_init);
pre_init();

function pick(array){
    var index = Math.floor(Math.random()*array.length);
    return [index, array[index]];
}

function init(){
    cancelAnimationFrame(anim_request);
    pixel_size = document.documentElement.clientWidth*pixel_ratio;
    array_size = [Math.ceil(document.documentElement.clientWidth/pixel_size), Math.ceil(document.documentElement.clientHeight/pixel_size)];
    canvas.width = array_size[0];
    canvas.height = array_size[1];
    array = [];
    for(var i = 0; i < array_size[0]; i++){
        array[i] = [];
        for(var j = 0; j < array_size[1]; j++){
            array[i][j] = Math.random() > random[rule_index] ? 0 : 1;
        }
    }

    born = rule.split("/")[0].replace("B", "").split("").map(function(x){ return parseInt(x); });
    survive = rule.split("/")[1].replace("S", "").split("").map(function(x){ return parseInt(x); });

    time = Date.now();
    update(true);
}

function update(first){
    anim_request = window.requestAnimationFrame(update);
    if(first !== true && Date.now()-time < ms) return;

    var new_gen = [];
    for(var i = 0; i < array_size[0]; i++){
        new_gen[i] = [];
        for(var j = 0; j < array_size[1]; j++){
            var neighbours = 0;
            var alive = array[i][j];

            var i2 = i+1;
            var i3 = i-1;
            var j2 = j+1;
            var j3 = j-1;

            if(i2 == array_size[0]){
                i2 = 0;
            }
            if(i3 == -1){
                i3 = array_size[0]-1;
            }
            if(j2 == array_size[1]){
                j2 = 0;
            }
            if(j3 == -1){
                j3 = array_size[1]-1;
            }

            neighbours += array[i2][j];
            neighbours += array[i2][j2];
            neighbours += array[i2][j3];
            neighbours += array[i3][j];
            neighbours += array[i3][j2];
            neighbours += array[i3][j3];
            neighbours += array[i][j3];
            neighbours += array[i][j2];

            if(alive){
                if(survive.indexOf(neighbours) > -1){
                    new_gen[i][j] = 1;
                }

                else{
                    new_gen[i][j] = 0;
                }
            }
            else if(!alive){
                if(born.indexOf(neighbours) > -1){
                    new_gen[i][j] = 1;
                }
                else{
                    new_gen[i][j] = 0;
                }
            }
        }
    }
    array = new_gen;
    draw();

    time = Date.now();
}

function draw(){
    var imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    var d = imgData.data;

    for(var i = 0; i < d.length; i += 4){
        if(array[(i >> 2)%array_size[0]][Math.floor((i >> 2)/array_size[0])]){
            if(theme == "dark"){
                d[i] = d[i+1] = d[i+2] = 255;
            }
            else{
                d[i] = d[i+1] = d[i+2] = 0;
            }
            d[i+3] = 255;
        }
        else{
            d[i+3] = 0;
        }
    }
    ctx.putImageData(imgData, 0, 0);
}

function mousemove_event(e){
    var x = Math.floor(e.clientX/pixel_size);
    var y = Math.floor(e.clientY/pixel_size);
    array[x][y] = 1;
    if(array[x][y-1] !== undefined){
        array[x][y-1] = 1;
    }
    if(array[x][y+1] !== undefined){
        array[x][y+1] = 1;
    }
    if(array[x+1] !== undefined){
        array[x+1][y] = 1;
        if(array[x+1][y+1] !== undefined){
            array[x+1][y+1] = 1;
        }
        if(array[x+1][y-1] !== undefined){
            array[x+1][y-1] = 1;
        }
    }
    if(array[x-1] !== undefined){
        array[x-1][y] = 1;
        if(array[x-1][y+1] !== undefined){
            array[x-1][y+1] = 1;
        }
        if(array[x-1][y-1] !== undefined){
            array[x-1][y-1] = 1;
        }
    }
}

function pre_init(){
    if(document.documentElement.clientWidth >= min_width){
        init();
        document.body.addEventListener("mousemove", mousemove_event);
    }
    else{
        cancelAnimationFrame(anim_request);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.body.removeEventListener("mousemove", mousemove_event);
    }
}
</script>
</body>
</html>